# node åŒ…ç®¡ç†å·¥å…·å…¨é¢åˆ†æ

js/node ç”Ÿæ€å¦‚æ­¤ç¹è£ï¼ŒåŒ…ç®¡ç†å·¥å…·åŠŸä¸å¯æ²¡ï¼Œæœ€æ—©çš„åŒ…ç®¡ç†å·¥å…·æ˜¯ npmï¼ˆNode Package Managerï¼‰ã€‚2010 å¹´ npm æ­£å¼å‘å¸ƒï¼Œå¹¶è¢« node æ”¯æŒï¼Œå…¶ä¸»è¦è´¡çŒ®æœ‰ä¸‰ï¼š

1. æä¾›ç»Ÿä¸€çš„å¼€å‘è€…ç¤¾åŒº
2. æä¾›ç½‘ç«™æ¥æ‰˜ç®¡åŒ…
3. æä¾› cli ä¾›å¼€å‘è€…ä½¿ç”¨

å¯ä»¥è¯´æ˜¯åŠŸä¸å¯æ²¡äº†

**ä½†æ˜¯ï¼**  
ä½†æ˜¯åœ¨å‰ç«¯å˜å¾—å¦‚æ­¤å¤æ‚ä¸”è¿½æ±‚æè‡´çš„ç¯å¢ƒä¸‹ï¼Œnpm çš„ä¸€äº›ç¼ºç‚¹é€ä¸€æ˜¾ç°ï¼Œå‡ºç°äº†æ›´é«˜æ•ˆæ›´å¥½ç”¨çš„åŒ…ç®¡ç†å·¥å…·ï¼Œæœ¬æ–‡å°†å¯¹ npm / yarn / pnpm å±•å¼€**å®¢è§‚å…¬æ­£**çš„åˆ†æ

## npm

ä¸»è¦å°±æ˜¯è¯´è¯´ npm çš„ä¸è¶³ ;P

### npm 2ï¼šç¼“æ…¢çš„ä¸‹è½½é€Ÿåº¦ï¼Œå¯èƒ½å­˜åœ¨çš„æ–‡ä»¶åè¿‡é•¿ bug

è¯´åˆ° npm å°±ä¸å¾—ä¸è¯´é‚£ä¸ªå¤§åé¼é¼çš„ `node_modules` æ–‡ä»¶å¤¹ï¼š

![node_modules-meme](http://blog.xiong35.cn/package-manager/node_modules-meme.jpeg)

![node_modules](http://blog.xiong35.cn/package-manager/node_modules.png)

> æˆ‘çœŸæ²¡åˆ»æ„å¾€é‡Œé¢æ”¾ä»€ä¹ˆå¤§æ–‡ä»¶ï¼Œä»–çœŸçš„å°±æ˜¯è¿™ä¹ˆå¤§

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ`node_modules` ä¸ºå•¥è¿™ä¹ˆå¤§å‘¢ï¼Ÿ

å…¶å®è¿™ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥ç†è§£ï¼Œæ¯•ç«Ÿä¾èµ–æ˜¯å±‚å±‚åµŒå¥—çš„ï¼Œä½ ä¾èµ–äº† reactï¼Œreact åˆä¼šé€’å½’çš„ä¾èµ–åˆ«çš„åŒ…ï¼Œä¸€å±‚å±‚å¥—ä¸‹å»å‘ˆæ ‘çŠ¶ç»“æ„ã€‚npmï¼ˆnpm 2 åŠä»¥å‰ç‰ˆæœ¬ï¼‰ è¯»åˆ° package.json ä¸­çš„ä¾èµ–é¡¹åå°±ä¼šå»ä¸‹è½½ä¾èµ–ï¼Œå¹¶æ ¹æ®å…¶**æ ‘ç»“æ„ç»„ç»‡æ–‡ä»¶å¤¹**ï¼š

![tree-struct](http://blog.xiong35.cn/package-manager/tree-struct.png)

å¯ä»¥çœ‹åˆ°ï¼Œ vue å’Œ react ä¾èµ–çš„ `foo` ç‰ˆæœ¬æœ‰è¾ƒå¤§å‡ºå…¥ï¼Œä¸èƒ½å¤ç”¨ï¼Œä½†æ˜¯ `bar` çš„ç‰ˆæœ¬åªæœ‰å°ç‰ˆæœ¬çš„ä¸åŒï¼Œnpm å´è¿˜æ˜¯æŠŠ `bar` ä¸‹è½½&å­˜å‚¨ äº†ä¸¤éï¼Œå› æ­¤å¸¦æ¥äº†**å­˜å‚¨å’Œä¸‹è½½æ—¶é—´çš„åŒé‡è´Ÿæ‹…**  
ä¸ä»…äºæ­¤ï¼ŒåµŒå¥—çš„æ ‘ç»“æ„å¯¼è‡´**æ–‡ä»¶è·¯å¾„åç§°å¯èƒ½å˜å¾—éå¸¸é•¿**ï¼Œä»¥è‡³äºè¶…å‡ºä¸€äº›å¤„ç†ç¨‹åºçš„ä¸Šçº¿ï¼ˆä¸»è¦è§äº windows ç³»ç»Ÿï¼‰

### npm 3ï¼šé•¿æ—¶é—´çš„ä¾èµ–è®¡ç®—ï¼Œä¸å®‰å…¨çš„ä¾èµ–

npm 3 åŠä»¥åç‰ˆæœ¬é‡‡ç”¨äº†ä¸ä¸€æ ·çš„æ€è·¯ï¼š**ä½¿ç”¨æ‰å¹³åŒ–å­˜å‚¨ç»“æ„**

![flatten](http://blog.xiong35.cn/package-manager/flatten.png)

è¯¶ï¼Œä½†æ˜¯è¿™æ ·ä¸¤ä¸ªåŒ…ä¾èµ–çš„ `foo` çš„å¤§ç‰ˆæœ¬ä¸åŒï¼Œåœ¨æ‰å¹³åŒ–ä¹‹åå´ä¾èµ–äº†åŒä¸€ä¸ªç‰ˆæœ¬ï¼Œè¿™æ ·ä¸ä¼šæœ‰é—®é¢˜å—ï¼Ÿ  
ç¡®å®ï¼Œè¿™å°±æ˜¯ npm ä½¿ç”¨æ‰å¹³åŒ–åå¸¦æ¥çš„**å®‰å…¨é—®é¢˜**ï¼Œå°½ç®¡ npm ä¼šæ ¹æ®[è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/lang/zh-CN/)ä¾èµ–*å°½åŠ›*è®¡ç®—å‡ºæ»¡è¶³å°½å¯èƒ½å¤šè¦æ±‚çš„æœ€åˆé€‚ç‰ˆæœ¬ï¼Œä½†è¿™åªæ˜¯*å°½åŠ›è€Œä¸º*ï¼Œ**ä¸èƒ½ä¿è¯æ¯ä¸ªä¾èµ–çš„ç‰ˆæœ¬éƒ½æ»¡è¶³è¦æ±‚ï¼Œä¹Ÿä¸èƒ½ä¿è¯ä¸åŒæœºå™¨ä¸Šå®‰è£…çš„ä¾èµ–æ˜¯ä¸€æ ·çš„**  
é™¤äº†å®‰å…¨é—®é¢˜ï¼Œè¿™ä¸ª**è®¡ç®—ç‰ˆæœ¬çš„è¿‡ç¨‹æœ¬èº«ä¹Ÿæ˜¯ç›¸å½“è€—æ—¶çš„**ï¼Œæ˜¯ npm å®‰è£…é€Ÿåº¦æ…¢çš„ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› 

é™¤äº†å®‰å…¨é—®é¢˜ï¼Œæ‰å¹³åŒ–è¿˜å¸¦æ¥äº†*å¹½çµåŒ…*çš„é—®é¢˜ï¼šç°åœ¨å½“ä¾èµ– import ä¸€ä¸ªå­ä¾èµ–ï¼Œä»–ä¼šä» `node_modules` `æ–‡ä»¶å¤¹ä¸‹æŸ¥æ‰¾ï¼Œä½†æ˜¯ç”±äºæ‰å¹³åŒ–çš„å¤„ç†ï¼Œnode_modules` æ–‡ä»¶å¤¹ä¸‹è¿˜æœ‰å¾ˆå¤šåˆ«çš„åŒ…çš„ä¾èµ–ï¼Œè¿™æ ·ä¸€æ¥ï¼Œä¸€ä¸ªä¾èµ– _import æœªå£°æ˜åœ¨è‡ªå·±çš„ package.json ä¸‹ã€å´å·²ç»è¢«åˆ«çš„ä¾èµ–å®‰è£…å¥½çš„å­ä¾èµ–_ æ˜¯**ä¸åˆé€»è¾‘ä½†å®é™…å¯è¡Œ**çš„

ç¼“è§£è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ï¼Œ`npm shrinkwrap` æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤ä¼šç”Ÿæˆ `npm-shrinkwrap.json` æ–‡ä»¶æ¥åœ¨ä¸åŒæœºå™¨ä¸Šç»Ÿä¸€ä¾èµ–ç‰ˆæœ¬ï¼ŒåŒæ—¶ç®€åŒ–ä¾èµ–è®¡ç®—çš„å·¥ä½œé‡

### npm 5ï¼šä»å­˜åœ¨é—®é¢˜

npm 5 å°†é”å®šä¾èµ–ç‰ˆæœ¬çš„ `package-lock.json` è®¾ä¸ºé»˜è®¤è¡Œä¸ºï¼ˆå…¶åŠŸèƒ½å’Œä¸Šæ–‡æåˆ°çš„ `npm-shrinkwrap.json` ç›¸åŒ  
npm 5 è¿˜å¢åŠ äº† `security vulnerabilities checks`ï¼Œä¼šæ£€æŸ¥å¯èƒ½å­˜åœ¨ç‰ˆæœ¬é—®é¢˜çš„ä¾èµ–é¡¹å¹¶æé†’ä½ å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼ˆè®©ä½ çŸ¥é“è‡ªå·±æ€ä¹ˆæ­»çš„ bushiï¼‰ï¼Œnpm 6 å¾ˆè´´å¿ƒçš„å¢åŠ äº† `npm audit` å‘½ä»¤æ¥ä¸»åŠ¨ç»Ÿè®¡æ˜“æŸçš„ä¾èµ–ï¼Œå¹¶æœ‰`nom audit fix` å‘½ä»¤æ¥å°è¯•ä¿®å¤ä¹‹ï¼ˆå¬èµ·æ¥ä¹Ÿä¸é‚£ä¹ˆå¯é ...ï¼‰

### npm æ€»ç»“

æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œå³ä½¿æ˜¯ç°åœ¨æœ€æ–°ç‰ˆçš„ npm ä¹Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. ä¸å®‰å…¨çš„ä¾èµ–
2. ä¸‹è½½+åˆ†æé€Ÿåº¦æ…¢
3. node_modules åºå¤§

## yarn

yarn æ˜¯ 2016 å¹´æ¨å‡ºçš„æ–°ä¸€ä»£åŒ…ç®¡ç†å·¥å…·ï¼Œå…¶ä¸»è¦æ”¹è¿›ç‚¹åœ¨äºä½¿ç”¨äº†å¹¶è¡Œä¸‹è½½ï¼ˆç›¸æ¯”è€Œè¨€ npm æ˜¯ä¸²è¡Œä¾æ¬¡ä¸‹è½½çš„ï¼‰ï¼Œæå‡äº†ä¸‹è½½é€Ÿåº¦

ç½‘ä¸Šæ–‡ç« è¯´äº†ä¸å°‘ yarn çš„ä¼˜ç‚¹ï¼Œä½†æ˜¯å…¶å® npm ä¹Ÿæœ‰åœ¨å¸å–å…¶ä¼˜ç‚¹ï¼Œç°åœ¨è¿™äº›å·®è·å·²ç»è¢«æŠ¹å¹³äº†ï¼Œä¸å¹ä¸é»‘çš„è¯ï¼Œç°åœ¨ï¼ˆ2022/2/22ï¼‰**yarn ä¸»è¦çš„ä¼˜åŠ¿å°±åœ¨äºå¹¶è¡Œä¸‹è½½äº†**

æ­¤å¤–ï¼Œyarn è¿˜æœ‰ä¸€ä¸ªç¥å¥‡çš„ featureï¼šPnPï¼ˆPlug and Playï¼‰

### PnP

ä» node_modules é‡ŒæŸ¥æ‰¾ä¾èµ–æ˜¯æ•´ä¸ª node ç”Ÿæ€çš„é»˜è®¤è¡Œä¸ºï¼Œå½“ä½ å¼•å…¥ä¸€ä¸ªåŒ…ï¼Œnode ä¼šä¸€å±‚å±‚å¾€çˆ¶ç›®å½•çš„ mode_modules æ–‡ä»¶å¤¹ä¸‹æŸ¥æ‰¾è¿™ä¸ªåŒ…ï¼Œç›´åˆ°æ‰¾åˆ°å®ƒæˆ–è€…æ‰¾åˆ°æ ¹ç›®å½•éƒ½æ²¡æ‰¾åˆ°è€ŒæŠ¥é”™...ä¼¼ä¹æ•´ä¸ªç”Ÿæ€éƒ½é»˜è®¤äº† nodeï¼Œä¸€å®šè¦æœ‰ node_modules

ä½†æ˜¯ yarn pnp ä¸è¿™ä¹ˆè®¤ä¸ºï¼Œé¦–å…ˆæˆ‘ä»¬è®¤è¯†åˆ°ï¼Œä½¿ç”¨ node_modules æ–‡ä»¶å¤¹å­˜å‚¨ä¾èµ–ä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š

1. node_modules å¤ªå¤§äº†ï¼å°†æ–‡ä»¶å†™å…¥å…¶ä¸­çš„ IO å¼€é”€å·¨å¤§
2. ä¸Šè¿°æŸ¥æ‰¾åŒ…çš„è¿‡ç¨‹ä¹Ÿæ¶‰åŠå¤šæ¬¡æ–‡ä»¶å¤¹è¯»å–å’Œæ–‡ä»¶æŸ¥æ‰¾ï¼ŒåŒæ ·æœ‰å¾ˆå¤§å¼€é”€
3. å¯¹ä¸‹è½½çš„ä¾èµ–å»é‡ä¼šå¾ˆå¤æ‚ï¼ˆé‡‡ç”¨æ‰å¹³ç»“æ„å’Œæ ‘çŠ¶ç»“æ„éƒ½æœ‰å¼Šç«¯ï¼‰

yarn pnp é‡‡ç”¨äº†å…¨æ–°çš„åŒ…ç®¡ç†ç­–ç•¥ï¼šPnPï¼Œç”¨ä¸€ä¸ª `.pnp.js` æ–‡ä»¶ä»£æ›¿æ•´ä¸ª node_modules æ–‡ä»¶å¤¹ï¼

æˆ‘ä»¬è¯•è¯•è¿™ä¸ª pnp æ¨¡å¼ï¼š

```bash
yarn init -y

yarn add foo --pnp
```

ç”Ÿæˆäº† `package.json`ã€`.pnp.js`ï¼Œè€Œæ²¡æœ‰ node_modulesï¼

`.pnp.js`æ–‡ä»¶æ˜¯ä¸ªå‡ åƒè¡Œå¤§å°çš„ js æ–‡ä»¶ï¼Œå…¶ä¸­å’Œä¾èµ–åŒ…ç›¸å…³éƒ¨åˆ†ä¸ºï¼š

![pnp.js](http://blog.xiong35.cn/package-manager/pnp.js.png)

è¦è¿è¡Œé¡¹ç›®å¿…é¡»ä½¿ç”¨ `yarn xxx` å‘½ä»¤æ¥è¿è¡Œï¼Œyarn ä¼šè‡ªåŠ¨æ‰§è¡Œ`.pnp.js`æ–‡ä»¶æ¥å¤„ç†ä¾èµ–ï¼Œè€Œä¸ç”¨å¼€å‘è€…ä¸‹è½½ï¼Œå¼€ç®±å³ç”¨ï¼ˆå³ Plug and Playï¼‰

### yarn æ€»ç»“

1. yarn çš„å¹¶è¡Œä¸‹è½½è§£å†³äº† npm ä¸‹è½½ç¼“æ…¢çš„é—®é¢˜
2. å’Œ npm ä¸€æ ·éƒ½æœ‰ lock æ–‡ä»¶æ¥é”å®šç‰ˆæœ¬
3. å’Œ npm ä¸€æ ·æœ‰ä¾èµ–ä¸å®‰å…¨çš„é—®é¢˜ï¼ŒåŒæ—¶ node_modules çš„å¤§å°è¿˜æ˜¯å¾ˆå¤§
4. yarn PnP è§£å†³äº†ç¬¬ 3 ç‚¹é—®é¢˜ï¼Œä½†æ˜¯å¼•å…¥çš„é—®é¢˜åœ¨äºè¿™ä¸ªæ¨¡å¼å¤ªåå¸¸è§„äº†ï¼Œå­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œä¸€äº›åŒ…åœ¨ pnp æ¨¡å¼ä¸‹å‡ºç°ä¾èµ–é”™è¯¯ï¼Œç›®å‰æ¥å—åº¦ä¸é«˜

> å° tipï¼š  
> ä¸ºäº†è®©å¼€å‘è€…æ›´å¹³æ»‘çš„è¿ç§»åˆ° yarnï¼Œyarn æä¾› [`yarn import`](https://classic.yarnpkg.com/blog/2018/06/04/yarn-import-package-lock/) æŒ‡ä»¤æ¥å°† `package-lock.json` è½¬åŒ–æˆ `yarn.lock` æ–‡ä»¶  
> <small>è¿™ä½•å°ä¸æ˜¯ä¸€ç§ ntr</small>

## pnpm

> performant npmï¼Œé‡å¤´æˆæ¥äº†

å¯¹äº npm çš„ç§ç§å¼Šç«¯ï¼Œpnpm é‡‡å–äº†ç¥å¥‡çš„è§£å†³æ€è·¯ï¼šå°†æ¯ä¸ªé¡¹ç›®çš„æ‰€æœ‰ä¾èµ–ä¸‹è½½åœ¨ç»Ÿä¸€çš„ç›®å½•ä¸‹ï¼Œè€Œåœ¨é¡¹ç›®çš„ node_modules ä¸­æ”¾ä¸ŠæŒ‡å‘é‚£ä¸ªç»Ÿä¸€ç›®å½•çš„ç¡¬é“¾æ¥ï¼ˆå¯ä»¥è¿‘ä¼¼ç†è§£ä¸ºå¿«æ·æ–¹å¼ï¼‰ï¼š

![pnpm-store](http://blog.xiong35.cn/package-manager/pnpm-store.jpeg)

è¿™æ ·å¸¦æ¥çš„å¥½å¤„æ˜¯ï¼š

1. å°½å¯èƒ½çš„å¤ç”¨åŒ…ï¼Œé¿å…äº†åœ¨å¤šä¸ªé¡¹ç›®ä¸­åå¤ä¸‹è½½&å­˜å‚¨åŒä¸€ä»½åŒ…ï¼Œé™ä½äº†å­˜å‚¨å ç”¨
2. install çš„æ—¶å€™åªæ˜¯åˆ›å»ºç¡¬é“¾æ¥è€Œä¸æ˜¯å¤åˆ¶æ–‡ä»¶ï¼Œå¤§å¤§æé«˜ä¸‹è½½é€Ÿåº¦
3. ä½¿ç”¨æ ‘çŠ¶ç»“æ„è€Œä¸æ˜¯æ‰å¹³ç»“æ„ï¼Œå¸¦æ¥äº†ä¾èµ–çš„å®‰å…¨æ€§
   1. å¦‚ä½•é¿å…è¿‡é•¿è·¯å¾„çš„é—®é¢˜ï¼Ÿpnpm ä¼šå¯¹ä¸€äº›åŒ…è¿›è¡Œ**æå‡**ï¼Œè®©ä»–ä¸åœ¨é‚£ä¹ˆæ·±çš„ä½ç½®

ä¸ªäººä½¿ç”¨ç»éªŒæ˜¯ï¼Œæˆ‘å°†ç”µè„‘ä¸Š 10 ä½™ä¸ªé¡¹ç›®å…¨éƒ¨è¿è‡³ pnpmï¼Œ c ç›˜çš„å­˜å‚¨ç©ºé—´å¢åŠ äº† 20 å¤š Gï¼ŒåŒæ—¶ pnpm ä¸‹è½½é€Ÿåº¦å¿«åˆ°é£èµ·ï¼Œè¶Šå¾€åè¶Šå¿«ï¼ˆèƒ½å¤ç”¨çš„åŒ…è¶Šå¤šï¼‰

æ­¤å¤–ï¼Œpnpm è¿˜æœ‰ä»¥ä¸‹ä¼˜ç‚¹ ğŸ˜ï¼š

1. ä»–æœ‰ 95% ç¿»è¯‘åº¦çš„ä¸­æ–‡å®˜ç½‘
2. å®˜ç½‘æ”¯æŒæ·±è‰²æ¨¡å¼
3. å®˜ç½‘ UI è¿˜æŒºå¥½çœ‹
4. å®˜ç½‘è¿˜æœ‰å“åº”å¼å¸ƒå±€

> è¯»è€…ï¼šå¥½äº†ä½ æ†‹è¯´äº†ï¼ŒçŸ¥é“ä½ å–œæ¬¢ pnpm äº†

æœ‰äººè¯´ pnpm å‡ ä¸ªå­—æ‰“èµ·æ¥ä¸é¡ºæ‰‹ï¼Ÿ

```bash
# è¿™ä½•å°ä¸æ˜¯ä¸€ç§ ntr
alias npm="pnpm";
alias yarn="pnpm";

alias whatever_U_like="pnpm";
```

## æ€»ç»“

| æŒ‡æ ‡   | npm                                   | yarn                                  | pnpm                       |
| ------ | ------------------------------------- | ------------------------------------- | -------------------------- |
| é€Ÿåº¦   | base line                             | å¤šçº¿ç¨‹                                | [ç¡¬é“¾æ¥è€Œéå¤åˆ¶æ–‡ä»¶](#)    |
| å®‰å…¨æ€§ | é  lock æ–‡ä»¶ï¼Œä¸å¯é                   | é  lock æ–‡ä»¶ï¼Œä¸å¯é                   | [å®‰å…¨](#)                  |
| å­˜å‚¨   | node_modules æ•£è½åœ¨å„é¡¹ç›®ï¼Œå­˜å‚¨å ç”¨å¤§ | node_modules æ•£è½åœ¨å„é¡¹ç›®ï¼Œå­˜å‚¨å ç”¨å¤§ | [åªæœ‰ä¸€ä»½ node_modules](#) |

ä¸ªäººæ„Ÿè§‰æ˜¯ pnpm > yarn > npm

é™„ä¸Š[è¿™ä¸ªåº“](https://github.com/pnpm/benchmarks-of-javascript-package-managers)åšçš„å„ä¸ªåŒ…ç®¡ç†å™¨ä¸‹è½½é€Ÿåº¦æ¯”è¾ƒï¼š

![benchmark](http://blog.xiong35.cn/package-manager/benchmark.svg)

å¯è§ pnpm é€Ÿåº¦é›€é£Ÿå¿«ï¼

## è¿˜ç­‰ä»€ä¹ˆï¼Œ`npm i -g pnpm` å‘€ï¼

## å‚è€ƒ

- [Yarn vs npm: Everything You Need to Know](https://www.sitepoint.com/yarn-vs-npm/)
- [State of Yarn 2 (Berry) in 2021](https://blog.hao.dev/state-of-yarn-2-berry-in-2021)
- [ä¸ºä»€ä¹ˆç°åœ¨æˆ‘æ›´æ¨è pnpm è€Œä¸æ˜¯ npm/yarn?](https://jishuin.proginn.com/p/763bfbd3bcff)
- [ä¸€æ–‡çœ‹æ‡‚ npmã€yarnã€pnpm ä¹‹é—´çš„åŒºåˆ«](https://juejin.cn/post/6844903616109641736)
